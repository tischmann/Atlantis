import Dialog from"./atlantis.dialog.min.js";import Upload from"./atlantis.upload.min.js";import Progress from"./atlantis.progress.min.js";import Sortable from"./atlantis.sortable.min.js";import Select from"./atlantis.select.min.js";export default class Article{constructor({form:e=null}={}){if(this.form=e,null===this.form&&(this.form=document.querySelector("[data-article]")),!this.form)return console.error("Форма с атрибутом [data-article] не найдена!");this.id=parseInt(this.form.dataset.article),this.textEditor=tinymce.init({language:"ru",target:this.form.querySelector('textarea[name="text"]'),paste_as_text:!0,autosave_ask_before_unload:!1,plugins:"preview importcss searchreplace autolink directionality code visualblocks visualchars fullscreen image link media template codesample table charmap pagebreak nonbreaking anchor insertdatetime advlist lists wordcount help charmap quickbars emoticons",editimage_cors_hosts:["picsum.photos"],menubar:"file edit view insert format tools table help",toolbar:"undo redo | bold italic underline strikethrough | fontsize blocks | alignleft aligncenter alignright alignjustify | outdent indent |  numlist bullist | forecolor backcolor removeformat | pagebreak | charmap emoticons | fullscreen  preview save print | insertfile image media template link anchor codesample",height:600,quickbars_selection_toolbar:"bold italic | quicklink h2 h3 blockquote quickimage quicktable",noneditable_class:"mceNonEditable",toolbar_mode:"wrap",contextmenu:"link image table",image_caption:!0,skin:"oxide",content_css:"/app.min.css",font_css:"https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap",image_advtab:!0,image_class_list:[{title:"Нет",value:"gallery-item"},{title:"rounded",value:"rounded gallery-item"},{title:"rounded-md",value:"rounded-md gallery-item"},{title:"rounded-lg",value:"rounded-lg gallery-item"},{title:"rounded-xl",value:"rounded-xl gallery-item"}],relative_urls:!1,images_upload_handler:(n,r)=>new Promise((t,a)=>{var e=new FormData;e.append("image",n.blob(),n.filename());const i=new XMLHttpRequest;i.withCredentials=!0,i.open("POST","/article/images"),i.setRequestHeader("Accept","application/json"),i.upload.onprogress=e=>{r(e.loaded/e.total*100)},i.onload=()=>{var e;return 403===i.status?a({message:"HTTP Ошибка: "+i.status,remove:!0}):i.status<200||300<=i.status?a("HTTP Ошибка: "+i.status):(e=JSON.parse(i.responseText))?.src?void t(e.src):a("Некорректный ответ: "+i.responseText)},i.onerror=()=>{a("Ошибка загрузки изображения: "+i.status)},i.send(e)})});var e=this.getGalleryContainer(),t=this.getVideosContainer(),a=this.getAttachementsContainer();const i=new Select(document.getElementById("select_field_category_id"));new Select(document.getElementById("locale-select"),{onchange:e=>{fetch("/locale/categories/"+e).then(e=>e.json()).then(({items:e})=>{i.update(e)})}}),this.imageSizeSelect=new Select(document.getElementById("select_field_image_size"),{onchange:e=>{var t=this.getImageElement(),a=parseInt(t.getAttribute("width"));let i=a;switch(e){case"16_9":i=Math.round(a/16*9);break;case"4_3":i=Math.round(a/4*3)}t.src=`/images/placeholder_${e}.svg`,t.setAttribute("height",i)}}),this.gallerySizeSelect=new Select(document.getElementById("select_field_gallery_image_size")),document.getElementById("pre-upload-image").addEventListener("click",function(){this.remove(),document.getElementById("upload-image-container").classList.remove("hidden")},{once:!0}),document.getElementById("upload-image").addEventListener("click",()=>{this.#uploadImageHandler()}),document.getElementById("delete-image").addEventListener("click",()=>{this.deleteImage()}),document.getElementById("pre-upload-gallery").addEventListener("click",function(){this.remove(),document.getElementById("upload-gallery-container").classList.remove("hidden")},{once:!0}),document.getElementById("upload-gallery").addEventListener("click",()=>{this.#uploadGalleryImageHandler()}),document.getElementById("upload-video")?.addEventListener("click",()=>{this.#uploadVideoHandler()}),document.getElementById("upload-attachement")?.addEventListener("click",()=>{this.#uploadAttachementHandler()}),document.getElementById("generate-tags").addEventListener("click",()=>{this.generateTags()}),document.getElementById("save-article")?.addEventListener("click",()=>{this.getTextTextarea().innerHTML=this.getTextEditorContent(),this.save()}),document.getElementById("add-article")?.addEventListener("click",()=>{this.getTextTextarea().innerHTML=this.getTextEditorContent(),this.add()}),document.getElementById("delete-article")?.addEventListener("click",e=>{this.delete({message:e.target.dataset.message})}),e.querySelectorAll("li").forEach(e=>{this.initGalleryItem(e)}),t.querySelectorAll("li").forEach(e=>{this.initVideosItem(e)}),a.querySelectorAll("li").forEach(e=>{this.initAttachementItem(e)}),new Sortable(e,{ondragend:()=>{this.updateGalleryInput()}}),new Sortable(a,{ondragend:()=>{this.updateAttachementsInput()}}),new Sortable(t,{ondragend:()=>{this.updateGalleryInput()}})}generateTags(){var e=parseInt(this.getTagsLimitElement().value);const a={};if(this.getTextElement().value.split(/[\s,]+/).forEach((e,t)=>{e=e.toLowerCase(),void 0===a[e]?a[e]=1:a[e]++}),!Object.entries(a).length)return"";this.getTagsElement().value=Object.entries(a).sort((e,t)=>t[1]-e[1]).slice(0,e).map(e=>e[0]).join(", ")}getImageElement(){return document.getElementById("article-image")}getTagsLimitElement(){return document.getElementById("tags-limit")}getTextElement(){return this.form.querySelector('input[name="text"]')}getTagsElement(){return this.form.querySelector('textarea[name="tags"]')}getImageInput(){return this.form.querySelector('input[name="image"]')}getGalleryContainer(){return this.form.querySelector(".gallery-container")}getGalleryInput(){return this.form.querySelector('input[name="gallery"]')}getVideosContainer(){return this.form.querySelector(".videos-container")}getVideosInput(){return this.form.querySelector('input[name="videos"]')}getAttachementsContainer(){return this.form.querySelector(".attachements-container")}gettAttachementsInput(){return this.form.querySelector('input[name="attachements"]')}getTextTextarea(){return this.form.querySelector('textarea[name="text"]')}getTextEditorContent(){return tinymce.activeEditor.getContent()}save(){this.fetch({url:"/article/"+this.id,method:"PUT",body:JSON.stringify(Object.fromEntries(new FormData(this.form))),onclose:()=>window.location.reload()})}add(){this.fetch({url:"/article",method:"POST",body:JSON.stringify(Object.fromEntries(new FormData(this.form))),onclose:function({id:e}){e?window.location.href="/edit/article/"+e:window.location.reload()}})}delete({message:e="Вы уверены, что хотите удалить статью?",confirmation:t=!0}={}){t&&!confirm(e)||this.fetch({url:"/article/"+this.id,method:"DELETE",onclose:function(){window.location.href="/edit/articles"}})}fetch({url:e,method:t,body:a=null,onclose:i=null}={}){null===i&&(i=function(){window.location.reload()}),fetch(e,{method:t,headers:{"Content-Type":"application/json"},body:a}).then(e=>{e.json().then(e=>{new Dialog({title:e.title,text:e.message,onclose:()=>{i(e)}})})})}#uploadImageHandler({image:e=null,size:a=null,success:t=function(){}}={}){if(null===e){const i=document.createElement("input");i.hidden=!0,i.type="file",i.accept=".jpg,.jpeg,.png,.webp,.gif,.bmp",i.multiple=!1,null===a&&(a=this.imageSizeSelect.getValue()),i.addEventListener("change",e=>{const t=this.getImageElement();t.src=`/images/placeholder_${a}.svg`,this.uploadImage({image:e.target.files[0],size:a,success:({image:e})=>{t.src="/images/articles/temp/"+e,this.getImageInput().setAttribute("value",e),this.changeImage({size:a}),i.remove()}})},{once:!0}),i.click()}else this.uploadImage({image:e,size:a,success:t})}uploadImage({image:e,size:t="16_9",success:a=function(){}}={}){if(!e)return conseole.error("Image is missing");var i=new FormData;i.append("image",e),i.append("size",t),new Upload({url:"/article/image",data:i,success:e=>{a(e)}})}deleteImage(){this.changeImage({size:"16_9",placeholder:!0})}changeImage({size:e="16_9",placeholder:t=!1}={}){var a=this.getImageElement(),i=parseInt(a.getAttribute("width"));let n=i;switch(e){case"16_9":n=Math.round(i/16*9);break;case"4_3":n=Math.round(i/4*3)}t&&(a.src=`/images/placeholder_${e}.svg`,this.getImageInput().setAttribute("value","")),a.setAttribute("height",n)}initGalleryItem(e){e.querySelector("button[data-delete]")?.addEventListener("click",()=>{e.classList.add("transition","scale-0"),setTimeout(()=>{e.remove(),this.updateGalleryInput()},200)},{once:!0})}updateGalleryInput(){const t=[];this.getGalleryContainer().querySelectorAll("li").forEach(e=>{t.push(e.querySelector("img").src.split("/").pop().replace("thumb_",""))}),this.getGalleryInput().setAttribute("value",t.join(";"))}uploadGalleryImage({image:i,size:n="16_9",success:r=function(){},progress:s=function(){}}={}){return i?new Promise((e,t)=>{var a=new FormData;a.append("image[]",i),a.append("size",n),new Upload({url:"/article/gallery",data:a,progress:s,success:r}),e()}):conseole.error("Image is missing")}#uploadGalleryImageHandler({image:e=null,size:t=null,success:a=function(){},progress:i=function(){}}={}){var n;null===e?((n=document.createElement("input")).hidden=!0,n.type="file",n.accept=".jpg,.jpeg,.png,.webp,.gif,.bmp",n.multiple=!0,n.addEventListener("change",e=>{Array.from(e.target.files).forEach(e=>{const t=this.getGalleryContainer(),a=new Progress(t);var i=this.gallerySizeSelect.getValue();let n=180;switch(i){case"16_9":n=180;break;case"4_3":n=240;break;case"1_1":n=320}this.uploadGalleryImage({image:e,size:i,progress:function(e){a.update(e)},success:({images:e})=>{a.destroy(),e.forEach(e=>{e=this.getGalleryItem({src:e,width:320,height:n});t.append(e),this.initGalleryItem(e)}),this.updateGalleryInput()}})})}),n.click()):this.uploadGalleryImage({image:e,size:t,success:a,progress:i})}getGalleryItem({src:e,width:t,height:a}){var i=document.createElement("li"),n=(i.classList.add("text-sm","select-none","relative","bg-gray-200","rounded-md"),document.createElement("img")),e=(n.src="/images/articles/temp/thumb_"+e,n.setAttribute("width",t),n.setAttribute("height",a),n.setAttribute("alt","..."),n.setAttribute("decoding","async"),n.setAttribute("loading","auto"),n.classList.add("block","w-full","rounded-md"),document.createElement("button"));return e.setAttribute("type","button"),e.setAttribute("data-delete",""),e.classList.add("block","outline-none","absolute","top-0","right-0","p-2","text-white","bg-red-600","rounded-md","hover:bg-red-500","cursor-pointer","transition","drop-shadow"),e.append(this.getSvgDelete()),i.append(n,e),i}updateVideosInput(){this.getVideosInput().setAttribute("value",Array.from(this.getVideosContainer().querySelectorAll("li > video")).map(e=>e.src.split("/").pop()).filter(e=>""!==e).join(";"))}initVideosItem(e){e.querySelector("button[data-delete]")?.addEventListener("click",()=>{e.classList.add("transition","scale-0"),setTimeout(()=>{e.remove(),this.updateVideosInput()},200)},{once:!0})}#uploadVideoHandler({file:e=null,progress:t=function(){},success:a=function(){}}={}){if(null===e){const e=document.createElement("input");e.hidden=!0,e.type="file",e.accept="video/*",e.multiple=!0,e.addEventListener("change",e=>{Array.from(e.target.files).forEach(e=>{const t=this.getVideosContainer(),a=new Progress(t);this.uploadVideo({file:e,progress:function(e){a.update(e)},success:({videos:e})=>{a.destroy(),e.forEach(e=>{e=this.getVideoItem({src:e});this.initVideosItem(e),t.append(e)}),this.updateVideosInput()}})})}),e.click()}else this.uploadVideo({file:e,progress:t,success:a})}uploadVideo({file:i=null,progress:n=function(){},success:r=function(){}}){if(!i)return conseole.error("File is missing");new Promise((e,t)=>{var a=new FormData;a.append("video[]",i),new Upload({url:"/article/videos",data:a,progress:n,success:r}),e()})}getVideoItem({src:e}){var t=document.createElement("li"),a=(t.classList.add("text-sm","select-none","relative"),document.createElement("video")),e=(a.src="/uploads/articles/temp/"+e,a.classList.add("block","w-full","rounded-md"),a.setAttribute("controls",""),document.createElement("button"));return e.setAttribute("type","button"),e.setAttribute("data-delete",""),e.classList.add("block","outline-none","absolute","top-0","right-0","p-2","text-white","bg-red-600","rounded-md","hover:bg-red-500","cursor-pointer","transition","drop-shadow"),e.append(this.getSvgDelete()),t.append(a,e),t}updateAttachementsInput(){this.gettAttachementsInput().setAttribute("value",Array.from(this.getAttachementsContainer().querySelectorAll("li > a")).map(e=>e.getAttribute("href").split("/").pop()).filter(e=>""!==e).join(";"))}getAttachementItem({file:e}){var t=document.createElement("li"),a=(t.classList.add("flex","flex-nowrap","gap-2","items-center","justify-between","text-gray-800","w-full","bg-gray-200","hover:bg-gray-300","rounded-lg"),document.createElement("a")),e=(a.setAttribute("href","/uploads/articles/temp/"+e),a.classList.add("text-ellipsis","hover:underline","overflow-hidden","whitespace-nowrap","grow","px-3","py-2"),a.setAttribute("target","_blank"),a.textContent=e,document.createElement("button"));return e.setAttribute("type","button"),e.setAttribute("data-delete",""),e.classList.add("block","outline-none","delete-attachement-button","cursor-pointer","text-white","hover:bg-red-500","transition","bg-red-600","rounded-lg","p-3"),e.append(this.getSvgDelete()),t.append(a,e),t}initAttachementItem(e){e.querySelector("button[data-delete]")?.addEventListener("click",()=>{e.classList.add("transition","scale-0"),setTimeout(()=>{e.remove(),this.updateAttachementsInput()},200)},{once:!0})}uploadAttachement({file:i=null,progress:n=function(){},success:r=function(){}}){if(!i)return conseole.error("File is missing");new Promise((e,t)=>{var a=new FormData;a.append("file[]",i),new Upload({url:"/article/attachements",data:a,progress:n,success:r}),e()})}#uploadAttachementHandler({file:e=null,progress:t=function(){},success:a=function(){}}={}){if(null===e){const e=document.createElement("input");e.hidden=!0,e.type="file",e.accept="*",e.multiple=!0,e.addEventListener("change",e=>{Array.from(e.target.files).forEach(e=>{const t=this.getAttachementsContainer(),a=new Progress(t);this.uploadAttachement({file:e,progress:function(e){a.update(e)},success:({files:e})=>{a.destroy(),e.forEach(e=>{e=this.getAttachementItem({file:e});this.initAttachementItem(e),t.append(e)}),this.updateAttachementsInput()}})})}),e.click()}else this.uploadAttachement({file:e,progress:t,success:a})}getSvgDelete(){var e=document.createElementNS("http://www.w3.org/2000/svg","svg"),t=(e.setAttribute("xmlns","http://www.w3.org/2000/svg"),e.setAttribute("fill","none"),e.setAttribute("viewBox","0 0 24 24"),e.setAttribute("stroke-width","1.5"),e.setAttribute("stroke","currentColor"),e.setAttribute("class","w-4 h-4"),document.createElementNS("http://www.w3.org/2000/svg","path"));return t.setAttribute("stroke-linecap","round"),t.setAttribute("stroke-linejoin","round"),t.setAttribute("d","m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0"),e.append(t),e}}
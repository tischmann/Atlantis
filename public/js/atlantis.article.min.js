import Dialog from"./atlantis.dialog.min.js";import Upload from"./atlantis.upload.min.js";import Progress from"./atlantis.progress.min.js";import Select from"./atlantis.select.min.js";export default class Article{constructor({form:e=null}={}){if(this.form=e,null===this.form&&(this.form=document.querySelector("[data-article]")),!this.form)return console.error("Форма с атрибутом [data-article] не найдена!");this.id=parseInt(this.form.dataset.article),this.textEditor=tinymce.init({language:"ru",target:this.form.querySelector('textarea[name="text"]'),paste_as_text:!0,autosave_ask_before_unload:!1,plugins:"preview importcss searchreplace autolink directionality code visualblocks visualchars fullscreen image link media template codesample table charmap pagebreak nonbreaking anchor insertdatetime advlist lists wordcount help charmap quickbars emoticons",editimage_cors_hosts:["picsum.photos"],menubar:"file edit view insert format tools table help",toolbar:"undo redo | bold italic underline strikethrough | fontsize blocks | alignleft aligncenter alignright alignjustify | outdent indent |  numlist bullist | forecolor backcolor removeformat | pagebreak | charmap emoticons | fullscreen  preview save print | insertfile image media template link anchor codesample",height:600,quickbars_selection_toolbar:"bold italic | quicklink h2 h3 blockquote quickimage quicktable",noneditable_class:"mceNonEditable",toolbar_mode:"sliding",contextmenu:"link image table",image_caption:!0,skin:"oxide",content_css:"/app.min.css",font_css:"https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap",image_advtab:!0,image_class_list:[{title:"Нет",value:"gallery-item"},{title:"rounded",value:"rounded gallery-item"},{title:"rounded-md",value:"rounded-md gallery-item"},{title:"rounded-lg",value:"rounded-lg gallery-item"},{title:"rounded-xl",value:"rounded-xl gallery-item"}],relative_urls:!1,images_upload_handler:(s,n)=>new Promise((t,i)=>{var e=new FormData;e.append("image",s.blob(),s.filename());const a=new XMLHttpRequest;a.withCredentials=!0,a.open("POST","/article/images"),a.setRequestHeader("Accept","application/json"),a.upload.onprogress=e=>{n(e.loaded/e.total*100)},a.onload=()=>{var e;return 403===a.status?i({message:"HTTP Ошибка: "+a.status,remove:!0}):a.status<200||300<=a.status?i("HTTP Ошибка: "+a.status):(e=JSON.parse(a.responseText))?.src?void t(e.src):i("Некорректный ответ: "+a.responseText)},a.onerror=()=>{i("Ошибка загрузки изображения: "+a.status)},a.send(e)})});var e=this.getGalleryContainer(),t=this.getVideosContainer(),i=this.getAttachementsContainer();const a=new Select(document.querySelector('select[name="category_id"]'));new Select(document.getElementById("locale-select"),{onchange:e=>{fetch("/locale/categories/"+e).then(e=>e.json()).then(({items:e})=>{a.update(e)})}}),this.imageSizeSelect=new Select(document.getElementById("select_field_image_size"),{onchange:e=>{var t=this.getImageElement(),i=parseInt(t.getAttribute("width"));let a=i;switch(e){case"16_9":a=Math.round(i/16*9);break;case"4_3":a=Math.round(i/4*3)}t.src=`/images/placeholder_${e}.svg`,t.setAttribute("height",a)}}),this.gallerySizeSelect=new Select(document.getElementById("select_field_gallery_image_size")),document.getElementById("pre-upload-image").addEventListener("click",function(){this.remove(),document.getElementById("upload-image-container").classList.remove("hidden")},{once:!0}),document.getElementById("upload-image").addEventListener("click",()=>{this.#uploadImageHandler()}),document.getElementById("delete-image").addEventListener("click",()=>{this.deleteImage()}),document.getElementById("pre-upload-gallery").addEventListener("click",function(){this.remove(),document.getElementById("upload-gallery-container").classList.remove("hidden")},{once:!0}),document.getElementById("upload-gallery").addEventListener("click",()=>{this.#uploadGalleryImageHandler()}),document.getElementById("upload-video")?.addEventListener("click",()=>{this.#uploadVideoHandler()}),document.getElementById("upload-attachement")?.addEventListener("click",()=>{this.#uploadAttachementHandler()}),document.getElementById("generate-tags").addEventListener("click",()=>{this.generateTags()}),document.getElementById("save-article")?.addEventListener("click",()=>{this.getTextTextarea().innerHTML=this.getTextEditorContent(),this.save()}),document.getElementById("add-article")?.addEventListener("click",()=>{this.getTextTextarea().innerHTML=this.getTextEditorContent(),this.add()}),document.getElementById("delete-article")?.addEventListener("click",e=>{this.delete({message:e.target.dataset.message})}),e.querySelectorAll("li").forEach(e=>{this.initGalleryItem(e)}),t.querySelectorAll("li").forEach(e=>{this.initVideosItem(e)}),i.querySelectorAll("li").forEach(e=>{this.initAttachementItem(e)}),$(e).sortable({placeholder:"ui-state-highlight",update:()=>{this.updateGalleryInput()}}),$(e).disableSelection(),$(i).sortable({placeholder:"ui-state-highlight",update:()=>{this.updateAttachementsInput()}}),$(i).disableSelection(),$(t).sortable({placeholder:"ui-state-highlight",update:()=>{this.updateVideosInput()}}),$(t).disableSelection()}generateTags(){var e=parseInt(this.getTagsLimitElement().value);const i={};if(this.getTextElement().value.split(/[\s,]+/).forEach((e,t)=>{e=e.toLowerCase(),void 0===i[e]?i[e]=1:i[e]++}),!Object.entries(i).length)return"";this.getTagsElement().value=Object.entries(i).sort((e,t)=>t[1]-e[1]).slice(0,e).map(e=>e[0]).join(", ")}getImageElement(){return document.getElementById("article-image")}getTagsLimitElement(){return document.getElementById("tags-limit")}getTextElement(){return this.form.querySelector('input[name="text"]')}getTagsElement(){return this.form.querySelector('textarea[name="tags"]')}getImageInput(){return this.form.querySelector('input[name="image"]')}getGalleryContainer(){return this.form.querySelector(".gallery-container")}getGalleryInput(){return this.form.querySelector('input[name="gallery"]')}getVideosContainer(){return this.form.querySelector(".videos-container")}getVideosInput(){return this.form.querySelector('input[name="videos"]')}getAttachementsContainer(){return this.form.querySelector(".attachements-container")}gettAttachementsInput(){return this.form.querySelector('input[name="attachements"]')}getTextTextarea(){return this.form.querySelector('textarea[name="text"]')}getTextEditorContent(){return tinymce.activeEditor.getContent()}save(){this.fetch({url:"/article/"+this.id,method:"PUT",body:JSON.stringify(Object.fromEntries(new FormData(this.form))),onclose:()=>window.location.reload()})}add(){this.fetch({url:"/article",method:"POST",body:JSON.stringify(Object.fromEntries(new FormData(this.form))),onclose:function({id:e}){e?window.location.href="/edit/article/"+e:window.location.reload()}})}delete({message:e="Вы уверены, что хотите удалить статью?",confirmation:t=!0}={}){t&&!confirm(e)||this.fetch({url:"/article/"+this.id,method:"DELETE",onclose:function(){window.location.href="/edit/articles"}})}fetch({url:e,method:t,body:i=null,onclose:a=null}={}){null===a&&(a=function(){window.location.reload()}),fetch(e,{method:t,headers:{"Content-Type":"application/json"},body:i}).then(e=>{e.json().then(e=>{new Dialog({title:e.title,text:e.message,onclose:()=>{a(e)}})})})}#uploadImageHandler({image:e=null,size:i=null,success:t=function(){}}={}){if(null===e){const a=document.createElement("input");a.hidden=!0,a.type="file",a.accept=".jpg,.jpeg,.png,.webp,.gif,.bmp",a.multiple=!1,null===i&&(i=this.imageSizeSelect.getValue()),a.addEventListener("change",e=>{const t=this.getImageElement();t.src=`/images/placeholder_${i}.svg`,this.uploadImage({image:e.target.files[0],size:i,success:({image:e})=>{t.src="/images/articles/temp/"+e,this.getImageInput().setAttribute("value",e),this.changeImage({size:i}),a.remove()}})},{once:!0}),a.click()}else this.uploadImage({image:e,size:i,success:t})}uploadImage({image:e,size:t="16_9",success:i=function(){}}={}){if(!e)return conseole.error("Image is missing");var a=new FormData;a.append("image",e),a.append("size",t),new Upload({url:"/article/image",data:a,success:e=>{i(e)}})}deleteImage(){this.changeImage({size:"16_9",placeholder:!0})}changeImage({size:e="16_9",placeholder:t=!1}={}){var i=this.getImageElement(),a=parseInt(i.getAttribute("width"));let s=a;switch(e){case"16_9":s=Math.round(a/16*9);break;case"4_3":s=Math.round(a/4*3)}t&&(i.src=`/images/placeholder_${e}.svg`,this.getImageInput().setAttribute("value","")),i.setAttribute("height",s)}initGalleryItem(e){e.querySelector("button[data-delete]")?.addEventListener("click",()=>{e.classList.add("transition","scale-0"),setTimeout(()=>{e.remove(),this.updateGalleryInput()},200)},{once:!0})}updateGalleryInput(){const t=[];this.getGalleryContainer().querySelectorAll("li:not(.ui-state-highlight)").forEach(e=>{t.push(e.querySelector("img").src.split("/").pop().replace("thumb_",""))}),this.getGalleryInput().setAttribute("value",t.join(";"))}uploadGalleryImage({image:a,size:s="16_9",success:n=function(){},progress:r=function(){}}={}){return a?new Promise((e,t)=>{var i=new FormData;i.append("image[]",a),i.append("size",s),new Upload({url:"/article/gallery",data:i,progress:r,success:n}),e()}):conseole.error("Image is missing")}#uploadGalleryImageHandler({image:e=null,size:t=null,success:i=function(){},progress:a=function(){}}={}){var s;null===e?((s=document.createElement("input")).hidden=!0,s.type="file",s.accept=".jpg,.jpeg,.png,.webp,.gif,.bmp",s.multiple=!0,s.addEventListener("change",e=>{Array.from(e.target.files).forEach(e=>{const t=this.getGalleryContainer(),i=new Progress(t);var a=this.gallerySizeSelect.getValue();let s=180;switch(a){case"16_9":s=180;break;case"4_3":s=240;break;case"1_1":s=320}this.uploadGalleryImage({image:e,size:a,progress:function(e){i.update(e)},success:({images:e})=>{i.destroy(),e.forEach(e=>{e=this.getGalleryItem({src:e,width:320,height:s});t.append(e),this.initGalleryItem(e)}),this.updateGalleryInput()}})})}),s.click()):this.uploadGalleryImage({image:e,size:t,success:i,progress:a})}getGalleryItem({src:e,width:t,height:i}){var a=document.createElement("li"),s=(a.classList.add("text-sm","select-none","relative","bg-gray-200","rounded-md"),document.createElement("img")),e=(s.src="/images/articles/temp/thumb_"+e,s.setAttribute("width",t),s.setAttribute("height",i),s.setAttribute("alt","..."),s.setAttribute("decoding","async"),s.setAttribute("loading","auto"),s.classList.add("block","w-full","rounded-md"),document.createElement("button"));return e.setAttribute("type","button"),e.setAttribute("data-delete",""),e.classList.add("block","outline-none","absolute","top-0","right-0","p-2","text-white","bg-red-600","rounded-md","hover:bg-red-500","cursor-pointer","transition","drop-shadow"),e.append(this.getSvgDelete()),a.append(s,e),a}updateVideosInput(){this.getVideosInput().setAttribute("value",Array.from(this.getVideosContainer().querySelectorAll("li > video")).map(e=>e.src.split("/").pop()).filter(e=>""!==e).join(";"))}initVideosItem(e){e.querySelector("button[data-delete]")?.addEventListener("click",()=>{e.classList.add("transition","scale-0"),setTimeout(()=>{e.remove(),this.updateVideosInput()},200)},{once:!0})}#uploadVideoHandler({file:e=null,progress:t=function(){},success:i=function(){}}={}){if(null===e){const e=document.createElement("input");e.hidden=!0,e.type="file",e.accept="video/*",e.multiple=!0,e.addEventListener("change",e=>{Array.from(e.target.files).forEach(e=>{const t=this.getVideosContainer(),i=new Progress(t);this.uploadVideo({file:e,progress:function(e){i.update(e)},success:({videos:e})=>{i.destroy(),e.forEach(e=>{e=this.getVideoItem({src:e});this.initVideosItem(e),t.append(e)}),this.updateVideosInput()}})})}),e.click()}else this.uploadVideo({file:e,progress:t,success:i})}uploadVideo({file:a=null,progress:s=function(){},success:n=function(){}}){if(!a)return conseole.error("File is missing");new Promise((e,t)=>{var i=new FormData;i.append("video[]",a),new Upload({url:"/article/videos",data:i,progress:s,success:n}),e()})}getVideoItem({src:e}){var t=document.createElement("li"),i=(t.classList.add("text-sm","select-none","relative"),document.createElement("video")),e=(i.src="/uploads/articles/temp/"+e,i.classList.add("block","w-full","rounded-md"),i.setAttribute("controls",""),document.createElement("button"));return e.setAttribute("type","button"),e.setAttribute("data-delete",""),e.classList.add("block","outline-none","absolute","top-0","right-0","p-2","text-white","bg-red-600","rounded-md","hover:bg-red-500","cursor-pointer","transition","drop-shadow"),e.append(this.getSvgDelete()),t.append(i,e),t}updateAttachementsInput(){this.gettAttachementsInput().setAttribute("value",Array.from(this.getAttachementsContainer().querySelectorAll("li > a")).map(e=>e.getAttribute("href").split("/").pop()).filter(e=>""!==e).join(";"))}getAttachementItem({file:e}){var t=document.createElement("li"),i=(t.classList.add("flex","flex-nowrap","gap-2","items-center","justify-between","text-gray-800","w-full","bg-gray-200","hover:bg-gray-300","rounded-lg"),document.createElement("a")),e=(i.setAttribute("href","/uploads/articles/temp/"+e),i.classList.add("text-ellipsis","hover:underline","overflow-hidden","whitespace-nowrap","grow","px-3","py-2"),i.setAttribute("target","_blank"),i.textContent=e,document.createElement("button"));return e.setAttribute("type","button"),e.setAttribute("data-delete",""),e.classList.add("block","outline-none","delete-attachement-button","cursor-pointer","text-white","hover:bg-red-500","transition","bg-red-600","rounded-lg","p-3"),e.append(this.getSvgDelete()),t.append(i,e),t}initAttachementItem(e){e.querySelector("button[data-delete]")?.addEventListener("click",()=>{e.classList.add("transition","scale-0"),setTimeout(()=>{e.remove(),this.updateAttachementsInput()},200)},{once:!0})}uploadAttachement({file:a=null,progress:s=function(){},success:n=function(){}}){if(!a)return conseole.error("File is missing");new Promise((e,t)=>{var i=new FormData;i.append("file[]",a),new Upload({url:"/article/attachements",data:i,progress:s,success:n}),e()})}#uploadAttachementHandler({file:e=null,progress:t=function(){},success:i=function(){}}={}){if(null===e){const e=document.createElement("input");e.hidden=!0,e.type="file",e.accept="*",e.multiple=!0,e.addEventListener("change",e=>{Array.from(e.target.files).forEach(e=>{const t=this.getAttachementsContainer(),i=new Progress(t);this.uploadAttachement({file:e,progress:function(e){i.update(e)},success:({files:e})=>{i.destroy(),e.forEach(e=>{e=this.getAttachementItem({file:e});this.initAttachementItem(e),t.append(e)}),this.updateAttachementsInput()}})})}),e.click()}else this.uploadAttachement({file:e,progress:t,success:i})}getSvgDelete(){var e=document.createElementNS("http://www.w3.org/2000/svg","svg"),t=(e.setAttribute("xmlns","http://www.w3.org/2000/svg"),e.setAttribute("fill","none"),e.setAttribute("viewBox","0 0 24 24"),e.setAttribute("stroke-width","1.5"),e.setAttribute("stroke","currentColor"),e.setAttribute("class","w-4 h-4"),document.createElementNS("http://www.w3.org/2000/svg","path"));return t.setAttribute("stroke-linecap","round"),t.setAttribute("stroke-linejoin","round"),t.setAttribute("d","m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0"),e.append(t),e}}
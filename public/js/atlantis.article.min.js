import Dialog from"./atlantis.dialog.min.js";import Upload from"./atlantis.upload.min.js";import Progress from"./atlantis.progress.min.js";import Sortable from"./atlantis.sortable.min.js";import Select from"./atlantis.select.min.js";export default class Article{constructor(){const e=document.getElementById("article-form"),t=document.querySelector('input[name="text"]'),a=document.querySelector(".gallery-container"),c=document.querySelector('input[name="gallery"]');var n=document.getElementById("pre-upload-gallery"),r=document.getElementById("upload-gallery");const o=document.getElementById("upload-gallery-container"),l=document.querySelector(".videos-container"),i=document.querySelector('input[name="videos"]');var s=document.getElementById("upload-video"),d=document.getElementById("upload-image"),u=document.getElementById("pre-upload-image");const m=document.getElementById("upload-image-container");var p=document.getElementById("delete-image");const g=document.getElementById("article-image"),v=document.querySelector('input[name="image"]'),f=document.querySelector(".attachements-container"),h=document.querySelector('input[name="attachements"]');var y=document.getElementById("upload-attachement");const b=document.querySelector('textarea[name="tags"]');var w=document.getElementById("save-article"),E=document.getElementById("add-article"),S=document.getElementById("delete-article");const A='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg>';function k(e,t,n=null,r=null){null===r&&(r=function(){window.location.reload()}),fetch(e,{method:t,headers:{"Content-Type":"application/json"},body:n}).then(e=>{e.json().then(e=>{new Dialog({title:e.title,text:e.message,onclose:()=>{r(e)}})})})}const L=new Quill("#quill-editor",{modules:{toolbar:[[{header:1},{header:2}],[{align:[]}],["bold","italic","underline","strike"],[{color:[]},{background:[]}],[{list:"ordered"},{list:"bullet"}],[{script:"sub"},{script:"super"}],[{indent:"-1"},{indent:"+1"}],["link","video","code-block"],["clean"]]},theme:"snow"}),j=(L.on("text-change",()=>{t.setAttribute("value",L.root.innerHTML)}),new Select(document.getElementById("select_field_category_id")));new Select(document.getElementById("locale-select"),{onchange:e=>{fetch("/locale/categories/"+e).then(e=>e.json()).then(({items:e})=>{j.update(e)})}});const q=new Select(document.getElementById("select_field_image_size"),{onchange:e=>{switch(g.src=`/images/placeholder_${e}.svg`,e){case"16_9":g.setAttribute("height","180");break;case"4_3":g.setAttribute("height","240");break;case"1_1":g.setAttribute("height","320")}}}),B=new Select(document.getElementById("select_field_gallery_image_size"));function I(e){e.querySelector(".delete-gallery-image-button").addEventListener("click",function(){e.classList.add("transition","scale-0"),setTimeout(()=>{e.remove();const t=[];a.querySelectorAll("li").forEach(e=>{t.push(e.querySelector("img").src.split("/").pop().replace("thumb_",""))}),c.setAttribute("value",t.join(";"))},200)},{once:!0})}function _(e){e.querySelector(".delete-videos-button").addEventListener("click",function(){e.classList.add("transition","scale-0"),setTimeout(()=>{e.remove();const t=[];l.querySelectorAll("li").forEach(e=>{t.push(e.querySelector("video").src.split("/").pop())}),i.setAttribute("value",t.join(";"))},200)},{once:!0})}function x(e){e.querySelector(".delete-attachement-button").addEventListener("click",function(){e.classList.add("transition","scale-0"),setTimeout(()=>{e.remove();const t=[];f.querySelectorAll("li").forEach(e=>{t.push(e.querySelector("a").getAttribute("href").split("/").pop())}),h.setAttribute("value",t.join(";"))},200)},{once:!0})}u.addEventListener("click",function(){this.remove(),m.classList.remove("hidden")},{once:!0}),d.addEventListener("click",function(){const r=document.createElement("input");r.hidden=!0,r.type="file",r.accept=".jpg,.jpeg,.png,.webp,.gif,.bmp",r.multiple=!1,r.addEventListener("change",e=>{var t=q.getValue(),n=new FormData;n.append("image",e.target.files[0]),n.append("size",t),g.src=`/images/placeholder_${t}.svg`,new Upload({url:"/article/image",data:n,success:({image:e})=>{g.src="/images/articles/temp/"+e,v.setAttribute("value",e),r.remove()}})},{once:!0}),r.click()}),p.addEventListener("click",function(){g.src="/images/placeholder.svg",v.setAttribute("value","")}),new Sortable(a,{ondragend:()=>{c.setAttribute("value",Array.from(a.querySelectorAll("li > img")).map(e=>e.src.split("/").pop()).filter(e=>""!==e).join(";"))}}),a.querySelectorAll("li").forEach(I),n.addEventListener("click",function(){this.remove(),o.classList.remove("hidden")},{once:!0}),r.addEventListener("click",()=>{var e=document.createElement("input");e.hidden=!0,e.type="file",e.accept=".jpg,.jpeg,.png,.webp,.gif,.bmp",e.multiple=!0,e.addEventListener("change",e=>{Array.from(e.target.files).forEach(i=>{new Promise((e,t)=>{var n=new FormData,r=(n.append("image[]",i),B.getValue());n.append("size",r);let o=180;switch(r){case"16_9":o=180;break;case"4_3":o=240;break;case"1_1":o=320}const l=new Progress(a);new Upload({url:"/article/gallery",data:n,progress:function(e){l.update(e)},success:({images:e})=>{l.destroy();const n=c.value.split(";").filter(e=>""!==e);e.forEach(e=>{var t=document.createElement("div"),t=(t.insertAdjacentHTML("beforeend",`<li class="text-sm select-none relative bg-gray-200 rounded-md"><img src="/images/articles/temp/thumb_${e}" width="320" height="${o}" alt="..." decoding="async" loading="auto" class="block w-full rounded-md"><div class="delete-gallery-image-button absolute top-0 right-0 p-2 text-white bg-red-600 rounded-md hover:bg-red-500 cursor-pointer transition drop-shadow">${A}</div></li>`),t.querySelector("li"));a.append(t),n.push(e),I(t)}),c.setAttribute("value",n.join(";"))}}),e()})})}),e.click()}),new Sortable(l,{ondragend:()=>{i.setAttribute("value",Array.from(l.querySelectorAll("li > video")).map(e=>e.src.split("/").pop()).filter(e=>""!==e).join(";"))}}),l.querySelectorAll("li").forEach(_),s.addEventListener("click",()=>{var e=document.createElement("input");e.hidden=!0,e.type="file",e.accept="video/*",e.multiple=!0,e.addEventListener("change",e=>{Array.from(e.target.files).forEach(r=>{new Promise((e,t)=>{var n=new FormData;n.append("video[]",r);const o=new Progress(l);new Upload({url:"/article/videos",data:n,progress:function(e){o.update(e)},success:({videos:e})=>{o.destroy();const r=i.value.split(";").filter(e=>""!==e);e.forEach(e=>{var t=document.createElement("div"),t=(t.insertAdjacentHTML("beforeend",`<li class="text-sm select-none relative"><video src="" class="block w-full rounded-md" controls></video><div class="delete-videos-button absolute top-0 right-0 p-2 text-white bg-red-600 rounded-md hover:bg-red-500 cursor-pointer transition drop-shadow" title="{{lang=delete}}">${A}</div></li>`),t.querySelector("li")),n=t.querySelector("video");_(t),n.src="/uploads/articles/temp/"+e,l.append(t),r.push(e)}),i.setAttribute("value",r.join(";"))}}),e()})})}),e.click()}),new Sortable(f,{ondragend:()=>{h.setAttribute("value",Array.from(f.querySelectorAll("li > a")).map(e=>e.getAttribute("href").split("/").pop()).filter(e=>""!==e).join(";"))}}),f.querySelectorAll("li").forEach(x),y.addEventListener("click",()=>{var e=document.createElement("input");e.hidden=!0,e.type="file",e.accept="*",e.multiple=!0,e.addEventListener("change",e=>{Array.from(e.target.files).forEach(r=>{new Promise((e,t)=>{var n=new FormData;n.append("file[]",r);const o=new Progress(f);new Upload({url:"/article/attachements",data:n,progress:function(e){o.update(e)},success:({files:e})=>{o.destroy();const r=h.value.split(";").filter(e=>""!==e);e.forEach(e=>{var t=document.createElement("div"),t=(t.insertAdjacentHTML("beforeend",`<li class="flex flex-nowrap gap-2 items-center justify-between text-gray-800 w-full bg-gray-200 hover:bg-gray-300 rounded-lg"><a href="" class="text-ellipsis hover:underline overflow-hidden whitespace-nowrap grow px-3 py-2" target="_blank"></a><div class="delete-attachement-button cursor-pointer text-white hover:bg-red-500 transition bg-red-600 rounded-lg p-3">${A}</div></li>`),t.querySelector("li")),n=t.querySelector("a");x(t),n.setAttribute("href","/uploads/articles/temp/"+e),n.innerText=e,f.append(t),r.push(e)}),h.setAttribute("value",r.join(";"))}}),e()})})}),e.click()}),document.getElementById("generate-tags").addEventListener("click",function(){var e=parseInt(document.getElementById("tags-limit").value);const n={};if(t.value.split(/[\s,]+/).forEach((e,t)=>{e=e.toLowerCase(),void 0===n[e]?n[e]=1:n[e]++}),!Object.entries(n).length)return"";b.value=Object.entries(n).sort((e,t)=>t[1]-e[1]).slice(0,e).map(e=>e[0]).join(", ")}),w?.addEventListener("click",function(){k("/article/"+e.dataset.id,"PUT",JSON.stringify(Object.fromEntries(new FormData(e))),function(){window.location.reload()})}),E?.addEventListener("click",function(){k("/article","POST",JSON.stringify(Object.fromEntries(new FormData(e))),function({id:e}){e?window.location.href="/edit/article/"+e:window.location.reload()})}),S?.addEventListener("click",function(){confirm(e.dataset.confirm)&&k("/article/"+e.dataset.id,"DELETE",null,function(){window.location.href="/edit/articles"})})}}
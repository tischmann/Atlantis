import Dialog from"./atlantis.dialog.min.js";import Upload from"./atlantis.upload.min.js";import Progress from"./atlantis.progress.min.js";import Sortable from"./atlantis.sortable.min.js";import Select from"./atlantis.select.min.js";export default class Article{svgDelete='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg>';constructor({}={}){this.form=document.getElementById("article-form"),this.id=parseInt(this.form.dataset.id);const e=new Quill("#quill-editor",{modules:{toolbar:[[{header:1},{header:2}],[{align:[]}],["bold","italic","underline","strike"],[{color:[]},{background:[]}],[{list:"ordered"},{list:"bullet"}],[{script:"sub"},{script:"super"}],[{indent:"-1"},{indent:"+1"}],["link","video","code-block"],["clean"]]},theme:"snow"}),t=(e.on("text-change",()=>{this.form.querySelector('input[name="text"]').setAttribute("value",e.root.innerHTML)}),new Select(document.getElementById("select_field_category_id"))),n=(new Select(document.getElementById("locale-select"),{onchange:e=>{fetch("/locale/categories/"+e).then(e=>e.json()).then(({items:e})=>{t.update(e)})}}),this.imageSizeSelect=new Select(document.getElementById("select_field_image_size"),{onchange:e=>{var t=this.getImageElement(),i=parseInt(t.getAttribute("width"));let r=i;switch(e){case"16_9":r=Math.round(i/16*9);break;case"4_3":r=Math.round(i/4*3)}t.src=`/images/placeholder_${e}.svg`,t.setAttribute("height",r)}}),this.gallerySizeSelect=new Select(document.getElementById("select_field_gallery_image_size")),document.getElementById("pre-upload-image").addEventListener("click",function(){this.remove(),document.getElementById("upload-image-container").classList.remove("hidden")},{once:!0}),document.getElementById("upload-image").addEventListener("click",()=>{this.#uploadImageHandler()}),document.getElementById("delete-image").addEventListener("click",()=>{this.deleteImage()}),new Sortable(this.getGalleryContainer(),{ondragend:()=>{this.updateGalleryInput()}}),this.getGalleryContainer().querySelectorAll("li").forEach(e=>{this.initGalleryItem(e)}),document.getElementById("pre-upload-gallery").addEventListener("click",function(){this.remove(),document.getElementById("upload-gallery-container").classList.remove("hidden")},{once:!0}),document.getElementById("upload-gallery").addEventListener("click",()=>{this.#uploadGalleryImageHandler()}),new Sortable(this.getVideosContainer(),{ondragend:()=>{this.updateGalleryInput()}}),document.querySelector(".attachements-container")),a=document.querySelector('input[name="attachements"]');var i=document.getElementById("upload-attachement");function s(e){e.querySelector(".delete-attachement-button").addEventListener("click",function(){e.classList.add("transition","scale-0"),setTimeout(()=>{e.remove();const t=[];n.querySelectorAll("li").forEach(e=>{t.push(e.querySelector("a").getAttribute("href").split("/").pop())}),a.setAttribute("value",t.join(";"))},200)},{once:!0})}this.getVideosContainer().querySelectorAll("li").forEach(e=>{this.initVideosItem(e)}),document.getElementById("upload-video")?.addEventListener("click",()=>{this.#uploadVideoHandler()}),new Sortable(n,{ondragend:()=>{a.setAttribute("value",Array.from(n.querySelectorAll("li > a")).map(e=>e.getAttribute("href").split("/").pop()).filter(e=>""!==e).join(";"))}}),n.querySelectorAll("li").forEach(s),i.addEventListener("click",()=>{var e=document.createElement("input");e.hidden=!0,e.type="file",e.accept="*",e.multiple=!0,e.addEventListener("change",e=>{Array.from(e.target.files).forEach(r=>{new Promise((e,t)=>{var i=new FormData;i.append("file[]",r);const l=new Progress(n);new Upload({url:"/article/attachements",data:i,progress:function(e){l.update(e)},success:({files:e})=>{l.destroy();const r=a.value.split(";").filter(e=>""!==e);e.forEach(e=>{var t=document.createElement("div"),t=(t.insertAdjacentHTML("beforeend",`<li class="flex flex-nowrap gap-2 items-center justify-between text-gray-800 w-full bg-gray-200 hover:bg-gray-300 rounded-lg"><a href="" class="text-ellipsis hover:underline overflow-hidden whitespace-nowrap grow px-3 py-2" target="_blank"></a><div class="delete-attachement-button cursor-pointer text-white hover:bg-red-500 transition bg-red-600 rounded-lg p-3">${this.svgDelete}</div></li>`),t.querySelector("li")),i=t.querySelector("a");s(t),i.setAttribute("href","/uploads/articles/temp/"+e),i.innerText=e,n.append(t),r.push(e)}),a.setAttribute("value",r.join(";"))}}),e()})})}),e.click()}),document.getElementById("generate-tags").addEventListener("click",()=>{this.generateTags()}),document.getElementById("save-article")?.addEventListener("click",()=>{this.save()}),document.getElementById("add-article")?.addEventListener("click",()=>{this.add()}),document.getElementById("delete-article")?.addEventListener("click",()=>{this.delete()})}generateTags(){var e=parseInt(this.getTagsLimitElement().value);const i={};if(this.getTextElement().value.split(/[\s,]+/).forEach((e,t)=>{e=e.toLowerCase(),void 0===i[e]?i[e]=1:i[e]++}),!Object.entries(i).length)return"";this.getTagsElement().value=Object.entries(i).sort((e,t)=>t[1]-e[1]).slice(0,e).map(e=>e[0]).join(", ")}getImageElement(){return document.getElementById("article-image")}getTagsLimitElement(){return document.getElementById("tags-limit")}getTextElement(){return this.form.querySelector('input[name="text"]')}getTagsElement(){return this.form.querySelector('textarea[name="tags"]')}getImageInput(){return this.form.querySelector('input[name="image"]')}getGalleryContainer(){return this.form.querySelector(".gallery-container")}getGalleryInput(){return this.form.querySelector('input[name="gallery"]')}getVideosContainer(){return this.form.querySelector(".videos-container")}getVideosInput(){return this.form.querySelector('input[name="videos"]')}save(){this.fetch({url:"/article/"+this.id,method:"PUT",body:JSON.stringify(Object.fromEntries(new FormData(this.form))),onclose:()=>window.location.reload()})}add(){this.fetch({url:"/article",method:"POST",body:JSON.stringify(Object.fromEntries(new FormData(this.form))),onclose:function({id:e}){e?window.location.href="/edit/article/"+e:window.location.reload()}})}delete(){confirm(this.form.dataset.confirm)&&this.fetch({url:"/article/"+this.id,method:"DELETE",onclose:function(){window.location.href="/edit/articles"}})}fetch({url:e,method:t,body:i=null,onclose:r=null}={}){null===r&&(r=function(){window.location.reload()}),fetch(e,{method:t,headers:{"Content-Type":"application/json"},body:i}).then(e=>{e.json().then(e=>{new Dialog({title:e.title,text:e.message,onclose:()=>{r(e)}})})})}#uploadImageHandler({image:e=null,size:i=null,success:t=function(){}}={}){if(null===e){const r=document.createElement("input");r.hidden=!0,r.type="file",r.accept=".jpg,.jpeg,.png,.webp,.gif,.bmp",r.multiple=!1,null===i&&(i=this.imageSizeSelect.getValue()),r.addEventListener("change",e=>{const t=this.getImageElement();t.src=`/images/placeholder_${i}.svg`,this.uploadImage({image:e.target.files[0],size:i,success:({image:e})=>{t.src="/images/articles/temp/"+e,this.getImageInput().setAttribute("value",e),this.changeImage({size:i}),r.remove()}})},{once:!0}),r.click()}else this.uploadImage({image:e,size:i,success:t})}uploadImage({image:e,size:t="16_9",success:i=function(){}}={}){if(!e)return conseole.error("Image is missing");var r=new FormData;r.append("image",e),r.append("size",t),new Upload({url:"/article/image",data:r,success:e=>{i(e)}})}deleteImage(){this.changeImage({size:"16_9",placeholder:!0})}changeImage({size:e="16_9",placeholder:t=!1}={}){var i=this.getImageElement(),r=parseInt(i.getAttribute("width"));let l=r;switch(e){case"16_9":l=Math.round(r/16*9);break;case"4_3":l=Math.round(r/4*3)}t&&(i.src=`/images/placeholder_${e}.svg`,this.getImageInput().setAttribute("value","")),i.setAttribute("height",l)}initGalleryItem(e){e.querySelector(".delete-gallery-image-button").addEventListener("click",()=>{e.classList.add("transition","scale-0"),setTimeout(()=>{e.remove(),this.updateGalleryInput()},200)},{once:!0})}updateGalleryInput(){const t=[];this.getGalleryContainer().querySelectorAll("li").forEach(e=>{t.push(e.querySelector("img").src.split("/").pop().replace("thumb_",""))}),this.getGalleryInput().setAttribute("value",t.join(";"))}uploadGalleryImage({image:r,size:l="16_9",success:n=function(){},progress:a=function(){}}={}){return r?new Promise((e,t)=>{var i=new FormData;i.append("image[]",r),i.append("size",l),new Upload({url:"/article/gallery",data:i,progress:a,success:n}),e()}):conseole.error("Image is missing")}#uploadGalleryImageHandler({image:e=null,size:t=null,success:i=function(){},progress:r=function(){}}={}){var l;null===e?((l=document.createElement("input")).hidden=!0,l.type="file",l.accept=".jpg,.jpeg,.png,.webp,.gif,.bmp",l.multiple=!0,l.addEventListener("change",e=>{Array.from(e.target.files).forEach(e=>{const i=this.getGalleryContainer(),t=new Progress(i);var r=this.gallerySizeSelect.getValue();let l=180;switch(r){case"16_9":l=180;break;case"4_3":l=240;break;case"1_1":l=320}this.uploadGalleryImage({image:e,size:r,progress:function(e){t.update(e)},success:({images:e})=>{t.destroy(),e.forEach(e=>{var t=document.createElement("div"),e=(t.insertAdjacentHTML("beforeend",this.getGalleryItemHtml({src:e,width:320,height:l})),t.querySelector("li"));i.append(e),this.initGalleryItem(e)}),this.updateGalleryInput()}})})}),l.click()):this.uploadGalleryImage({image:e,size:t,success:i,progress:r})}getGalleryItemHtml({src:e,width:t,height:i}){return`<li class="text-sm select-none relative bg-gray-200 rounded-md"><img src="/images/articles/temp/thumb_${e}" width="${t}" height="${i}" alt="..." decoding="async" loading="auto" class="block w-full rounded-md"><div class="delete-gallery-image-button absolute top-0 right-0 p-2 text-white bg-red-600 rounded-md hover:bg-red-500 cursor-pointer transition drop-shadow">${this.svgDelete}</div></li>`}updateVideosInput(){this.getVideosInput().setAttribute("value",Array.from(this.getVideosContainer().querySelectorAll("li > video")).map(e=>e.src.split("/").pop()).filter(e=>""!==e).join(";"))}initVideosItem(e){e.querySelector(".delete-videos-button").addEventListener("click",()=>{e.classList.add("transition","scale-0"),setTimeout(()=>{e.remove(),this.updateVideosInput()},200)},{once:!0})}#uploadVideoHandler({file:e=null,progress:t=function(){},success:i=function(){}}={}){if(null===e){const e=document.createElement("input");e.hidden=!0,e.type="file",e.accept="video/*",e.multiple=!0,e.addEventListener("change",e=>{Array.from(e.target.files).forEach(e=>{const i=this.getVideosContainer(),t=new Progress(i);this.uploadVideo({file:e,progress:function(e){t.update(e)},success:({videos:e})=>{t.destroy(),e.forEach(e=>{var t=document.createElement("div"),e=(t.insertAdjacentHTML("beforeend",this.getVideoItemHtml({src:e})),t.querySelector("li"));this.initVideosItem(e),i.append(e)}),this.updateVideosInput()}})})}),e.click()}else this.uploadVideo({file:e,progress:t,success:i})}uploadVideo({file:r=null,progress:l=function(){},success:n=function(){}}){if(!r)return conseole.error("File is missing");new Promise((e,t)=>{var i=new FormData;i.append("video[]",r),new Upload({url:"/article/videos",data:i,progress:l,success:n}),e()})}getVideoItemHtml({src:e}){return`<li class="text-sm select-none relative"><video src="/uploads/articles/temp/${e}" class="block w-full rounded-md" controls></video><div class="delete-videos-button absolute top-0 right-0 p-2 text-white bg-red-600 rounded-md hover:bg-red-500 cursor-pointer transition drop-shadow" title="{{lang=delete}}">${this.svgDelete}</div></li>`}}
export default class Atlantis{#handlers=new Map;constructor({log:t=!1}={}){this.log=t,this.uuid=this.getUUID()||this.setUUID(),new MutationObserver(t=>{this.#removeEventListeners(t[0]?.removedNodes)}).observe(document,{childList:!0,subtree:!0})}#removeEventListeners(t){return t instanceof NodeList&&t.forEach(t=>{1==t.nodeType&&(this.off(t),this.#removeEventListeners(t.childNodes))}),this}on(t,e,s,n=!1){var o=this.#handlers.get(e)||new Set;return t.addEventListener(e,s,n),o.add({element:t,handler:s,capture:n}),this.#handlers.set(e,o),this}off(t,e=void 0,s=void 0){for(var[n,o]of this.#handlers)if(n===e){for(const a of o)if(a.handler===s&&(t.removeEventListener(n,a.handler,a.capture),o.delete(a),s))return this;if(e)return this}return this}tag(t,{className:e=null,classList:s=[],css:n={},data:o={},attr:a={},text:i=null,html:r=null,append:l=[],on:c={}}={}){const d=document.createElement(t);return e&&(d.className=e),s.length&&d.classList.add(...s),n&&this.css(d,n),o&&this.data(d,o),a&&this.attr(d,a),i?d.textContent=i:r&&(d.innerHTML=r),l?.length&&d.append(...l),Object.entries(c).forEach(([t,e])=>{this.on(d,t,e)}),d}css(s,t={}){return t instanceof Object&&Object.entries(t).forEach(([t,e])=>{s.style[t]=e}),this}data(s,t={}){return Object.entries(t).forEach(([t,e])=>{s.dataset[t]=e}),this}attr(s,t={}){return Object.entries(t).forEach(([t,e])=>{s.setAttribute(t,e)}),this}handleEvent(t){"change"===t.type&&this.setArticleRating(t.target.closest("form[data-id]").dataset.id,t.target.value)}fetch(t,{method:e="POST",headers:s={Accept:"application/json"},body:n=void 0,success:o=function(){},failure:a=function(){}}={}){"string"!=typeof n&&n instanceof FormData==!1&&(n=JSON.stringify(n)),s={Accept:"application/json",...s},"string"==typeof n&&(s={...s,"Content-Length":n.length.toString()}),fetch(t,{method:e,headers:s,body:n}).then(t=>{if(!t.ok)return a(t.statusText),console.error("Atlantis.fetch():",t.status);"application/json"===s.Accept?t.json().then(t=>{this.log&&console.log("Atlantis.fetch():",t),o(t)}).catch(t=>{a(t),console.error("Atlantis.fetch():",t)}):t.text().then(t=>{this.log&&console.log("Atlantis.fetch():",t),o(t)}).catch(t=>{a(t),console.error("Atlantis.fetch():",t)})}).catch(t=>{a(t),console.error("Atlantis.fetch():",t)})}uniqueid(){return self.crypto.randomUUID()}toInt(t){return parseInt(t,10)}getCookie(t){t=document.cookie.match(new RegExp(`(?:^|; )${t.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g,"\\$1")}=([^;]*)`));return t?decodeURIComponent(t[1]):void 0}setCookie(t,e,s={}){s={path:"/",secure:!0,domain:window.location.hostname,samesite:"strict",expires:new Date(Date.now()+121e7).toUTCString(),...s};let n=encodeURIComponent(t)+"="+encodeURIComponent(e);Object.entries(s).forEach(([t,e])=>{n+=`; ${t}=`+(e||"")}),document.cookie=n}getUUID(t="atlantis_uuid"){return this.getCookie(t)}setUUID(t="atlantis_uuid"){this.setCookie(t,self.crypto.randomUUID())}dialog({title:t,message:e,buttons:s=[],onclose:n=function(){}}={}){var o="atlantis-dialog-"+this.uniqueid();const a=this.tag("dialog",{classList:["m-0","rounded","shadow-xl","fixed","md:w-96","w-full","top-1/2","left-1/2","transform","-translate-x-1/2","-translate-y-1/2"],attr:{id:o},on:{close:n}}),i=this.tag("div",{classList:["flex","items-center","gap-4"]});return s.forEach(t=>{var e=this.tag("button",{attr:{type:"button"},className:t?.class||"bg-sky-600 text-white hover:bg-sky-500 focus:bg-sky-500 active:bg-sky-500",classList:["inline-block","w-full","px-6","py-2.5","text-white","font-medium","text-xs","leading-tight","uppercase","rounded","shadow-md","hover:shadow-lg","focus:shadow-lg","focus:outline-none","focus:ring-0","active:shadow-lg","transition","duration-150","ease-in-out"],html:t?.text||"Button",on:{click:()=>{"function"==typeof t?.callback&&t?.callback(),a.close()}}});i.append(e)}),a.append(this.tag("form",{attr:{method:"dialog"},append:[this.tag("button",{classList:["absolute","top-4","right-4","ring-0","focus:ring-0","outline-none","text-gray-500"],append:[this.tag("i",{classList:["fas","fa-times","text-xl"],attr:{value:"cancel"}})]}),this.tag("span",{classList:["block","text-xl","font-medium","leading-normal","text-gray-800","pr-12","mb-4","truncate"],text:t}),this.tag("div",{classList:["mb-4"],html:e}),i]})),document.body.append(a),a}enter(s){return new IntersectionObserver((t,e)=>{t.forEach(t=>{t.isIntersecting&&s(t.target)})},{root:null,rootMargin:"0px",threshold:.1})}lazyload(e,{url:s="",token:n="",page:o=1,next:a=1,last:i=1,limit:r=1,sort:l="",order:c="",search:d="",callback:h=function(){}}={}){const u=this.tag("div",{classList:["flex","justify-center","items-center"],attr:{"data-atlantis-lazyload-target":!0},append:[this.tag("div",{classList:["spinner-grow","inline-block","w-8","h-8","bg-sky-500","rounded-full","opacity-0"],attr:{role:"status"}})]}),g=(e.appendChild(u),this.enter(t=>{if(o==i)return this.log&&console.log("Atlantis.lazyload(): No more pages to load"),g.disconnect(),u.remove();this.fetch(s,{headers:{"Content-Type":"application/json","X-Csrf-Token":n},body:{page:o,next:a,last:i,limit:r,sort:l,order:c,search:d},success:t=>{u.insertAdjacentHTML("beforebegin",t.html),o=t.page,a=t.next,i=t.last,n=t.token,e.appendChild(u),h()}})}));g.observe(u)}}
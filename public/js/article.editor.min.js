const textElement=document.querySelector('input[name="text"]'),galleryContainer=document.querySelector(".gallery-container"),galleryInput=document.querySelector('input[name="gallery"]'),preUploadGalleryButton=document.getElementById("pre-upload-gallery"),uploadGalleryButton=document.getElementById("upload-gallery"),uploadGalleryContainer=document.getElementById("upload-gallery-container"),videosContainer=document.querySelector(".videos-container"),videosInput=document.querySelector('input[name="videos"]'),uploadVideoButton=document.getElementById("upload-video"),uploadImageButton=document.getElementById("upload-image"),preUploadImage=document.getElementById("pre-upload-image"),uploadImageContainer=document.getElementById("upload-image-container"),deleteImageButton=document.getElementById("delete-image"),articleImage=document.getElementById("article-image"),articleImageInput=document.querySelector('input[name="image"]'),attachementsContainer=document.querySelector(".attachements-container"),attachementInput=document.querySelector('input[name="attachements"]'),uploadAttachementButton=document.getElementById("upload-attachement"),tagsElement=document.querySelector('textarea[name="tags"]'),saveButton=document.getElementById("save-article"),addButton=document.getElementById("add-article"),deleteButton=document.getElementById("delete-article"),svgBin='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg>',textEditor=new Quill("#quill-editor",{modules:{toolbar:[[{header:1},{header:2}],[{align:[]}],["bold","italic","underline","strike"],[{color:[]},{background:[]}],[{list:"ordered"},{list:"bullet"}],[{script:"sub"},{script:"super"}],[{indent:"-1"},{indent:"+1"}],["link","video","code-block"],["clean"]]},theme:"snow"}),categorySelect=(textEditor.on("text-change",()=>{textElement.setAttribute("value",textEditor.root.innerHTML)}),document.select(document.getElementById("select_field_category_id"))),localeSelect=document.select(document.getElementById("locale-select"),{onchange:e=>{fetch("/locale/categories/"+e).then(e=>e.json()).then(({items:e})=>{categorySelect.update(e)})}}),imageSizeSelect=document.select(document.getElementById("select_field_image_size"),{onchange:e=>{switch(articleImage.src=`/images/placeholder_${e}.svg`,e){case"16_9":articleImage.setAttribute("height","180");break;case"4_3":articleImage.setAttribute("height","240");break;case"1_1":articleImage.setAttribute("height","320")}}}),gallerySizeSelect=document.select(document.getElementById("select_field_gallery_image_size"));function initGalleryItem(e){e.querySelector(".delete-gallery-image-button").addEventListener("click",function(){e.classList.add("transition","scale-0"),setTimeout(()=>{e.remove();const t=[];galleryContainer.querySelectorAll("li").forEach(e=>{t.push(e.querySelector("img").src.split("/").pop().replace("thumb_",""))}),galleryInput.setAttribute("value",t.join(";"))},200)},{once:!0})}function initVideosItem(e){e.querySelector(".delete-videos-button").addEventListener("click",function(){e.classList.add("transition","scale-0"),setTimeout(()=>{e.remove();const t=[];videosContainer.querySelectorAll("li").forEach(e=>{t.push(e.querySelector("video").src.split("/").pop())}),videosInput.setAttribute("value",t.join(";"))},200)},{once:!0})}function initAttachementItem(e){e.querySelector(".delete-attachement-button").addEventListener("click",function(){e.classList.add("transition","scale-0"),setTimeout(()=>{e.remove();const t=[];attachementsContainer.querySelectorAll("li").forEach(e=>{t.push(e.querySelector("a").getAttribute("href").split("/").pop())}),attachementInput.setAttribute("value",t.join(";"))},200)},{once:!0})}preUploadImage.addEventListener("click",function(){this.remove(),uploadImageContainer.classList.remove("hidden")},{once:!0}),uploadImageButton.addEventListener("click",function(){const a=document.createElement("input");a.hidden=!0,a.type="file",a.accept=".jpg,.jpeg,.png,.webp,.gif,.bmp",a.multiple=!1,a.addEventListener("change",e=>{var t=imageSizeSelect.value(),n=new FormData;n.append("image",e.target.files[0]),n.append("size",t),articleImage.src=`/images/placeholder_${t}.svg`,document.upload("/article/image",n).then(({image:e})=>{articleImage.src="/images/articles/temp/"+e,articleImageInput.setAttribute("value",e),a.remove()})},{once:!0}),a.click()}),deleteImageButton.addEventListener("click",function(){articleImage.src="/images/placeholder.svg",articleImageInput.setAttribute("value","")}),document.sortable(galleryContainer,{ondragend:()=>{galleryInput.setAttribute("value",Array.from(galleryContainer.querySelectorAll("li > img")).map(e=>e.src.split("/").pop()).filter(e=>""!==e).join(";"))}}),galleryContainer.querySelectorAll("li").forEach(initGalleryItem),preUploadGalleryButton.addEventListener("click",function(){this.remove(),uploadGalleryContainer.classList.remove("hidden")},{once:!0}),uploadGalleryButton.addEventListener("click",()=>{var e=document.createElement("input");e.hidden=!0,e.type="file",e.accept=".jpg,.jpeg,.png,.webp,.gif,.bmp",e.multiple=!0,e.addEventListener("change",e=>{Array.from(e.target.files).forEach(i=>{new Promise((e,t)=>{var n=new FormData;n.append("image[]",i);const a=gallerySizeSelect.value();n.append("size",a);let l=180;switch(a){case"16_9":l=180;break;case"4_3":l=240;break;case"1_1":l=320}const o=document.progress(0,galleryContainer);document.upload("/article/gallery",n,function(e){o.update(e)}).then(({images:e})=>{o.destroy();const n=galleryInput.value.split(";").filter(e=>""!==e);e.forEach(e=>{var t=document.createElement("div"),t=(t.insertAdjacentHTML("beforeend",`<li class="text-sm select-none relative"><img src="/images/placeholder_${a}.svg" width="320" height="${l}" alt="..." decoding="async" loading="lazy" class="block w-full rounded-md"><div class="delete-gallery-image-button absolute top-0 right-0 p-2 text-white bg-red-600 rounded-md hover:bg-red-500 cursor-pointer transition drop-shadow">${svgBin}</div></li>`),t.querySelector("li"));galleryContainer.append(t),t.querySelector("img").src="/images/articles/temp/thumb_"+e,n.push(e),initGalleryItem(t)}),galleryInput.setAttribute("value",n.join(";"))}),e()})})}),e.click()}),document.sortable(videosContainer,{ondragend:()=>{videosInput.setAttribute("value",Array.from(videosContainer.querySelectorAll("li > video")).map(e=>e.src.split("/").pop()).filter(e=>""!==e).join(";"))}}),videosContainer.querySelectorAll("li").forEach(initVideosItem),uploadVideoButton.addEventListener("click",()=>{var e=document.createElement("input");e.hidden=!0,e.type="file",e.accept="video/*",e.multiple=!0,e.addEventListener("change",e=>{Array.from(e.target.files).forEach(a=>{new Promise((e,t)=>{var n=new FormData;n.append("video[]",a);const l=document.progress(0,videosContainer);document.upload("/article/videos",n,function(e){l.update(e)}).then(({videos:e})=>{l.destroy();const a=videosInput.value.split(";").filter(e=>""!==e);e.forEach(e=>{var t=document.createElement("div"),t=(t.insertAdjacentHTML("beforeend",`<li class="text-sm select-none relative"><video src="" class="block w-full rounded-md" controls></video><div class="delete-videos-button absolute top-0 right-0 p-2 text-white bg-red-600 rounded-md hover:bg-red-500 cursor-pointer transition drop-shadow" title="{{lang=delete}}">${svgBin}</div></li>`),t.querySelector("li")),n=t.querySelector("video");initVideosItem(t),n.src="/uploads/articles/temp/"+e,videosContainer.append(t),a.push(e)}),videosInput.setAttribute("value",a.join(";"))}),e()})})}),e.click()}),document.sortable(attachementsContainer,{ondragend:()=>{attachementInput.setAttribute("value",Array.from(attachementsContainer.querySelectorAll("li > a")).map(e=>e.getAttribute("href").split("/").pop()).filter(e=>""!==e).join(";"))}}),attachementsContainer.querySelectorAll("li").forEach(initAttachementItem),uploadAttachementButton.addEventListener("click",()=>{var e=document.createElement("input");e.hidden=!0,e.type="file",e.accept="*",e.multiple=!0,e.addEventListener("change",e=>{Array.from(e.target.files).forEach(a=>{new Promise((e,t)=>{var n=new FormData;n.append("file[]",a);const l=document.progress(0,attachementsContainer);document.upload("/article/attachements",n,function(e){l.update(e)}).then(({files:e})=>{l.destroy();const a=attachementInput.value.split(";").filter(e=>""!==e);e.forEach(e=>{var t=document.createElement("div"),t=(t.insertAdjacentHTML("beforeend",`<li class="flex flex-nowrap gap-2 items-center justify-between text-gray-800 w-full bg-gray-200 hover:bg-gray-300 rounded-lg"><a href="" class="text-ellipsis hover:underline overflow-hidden whitespace-nowrap grow px-3 py-2" target="_blank"></a><div class="delete-attachement-button cursor-pointer text-white hover:bg-red-500 transition bg-red-600 rounded-lg p-3">${svgBin}</div></li>`),t.querySelector("li")),n=t.querySelector("a");initAttachementItem(t),n.setAttribute("href","/uploads/articles/temp/"+e),n.innerText=e,attachementsContainer.append(t),a.push(e)}),attachementInput.setAttribute("value",a.join(";"))}),e()})})}),e.click()}),document.getElementById("generate-tags").addEventListener("click",function(){tagsElement.value=document.tags(textElement.value,document.getElementById("tags-limit").value)}),saveButton?.addEventListener("click",function(){var e=document.getElementById("article-form");fetch("/article/"+e.dataset.id,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(Object.fromEntries(new FormData(e)))}).then(e=>{e.json().then(e=>{document.dialog({title:e.title,text:e.message,onclose:()=>{window.location.reload()}})})})}),addButton?.addEventListener("click",function(){var e=document.getElementById("article-form");fetch("/article",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(Object.fromEntries(new FormData(e)))}).then(e=>{e.json().then(e=>{document.dialog({title:e.title,text:e.message,onclose:()=>{e.id?window.location.href="/edit/article/"+e.id:window.location.reload()}})})})});